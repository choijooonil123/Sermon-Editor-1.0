<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Web-Bible-Paragraph 3.1 Â· Sermon Editor</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#161922; --text:#e6e8ef; --muted:#9aa0ab;
      --accent:#6ea8fe; --border:#252a36; --danger:#ff6b6b; --ok:#4ade80;
      --titleBlue:#9fd0ff; --paper:#ffffff; --ink:#0f1115;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
      background:var(--bg); color:var(--text);
      display:grid; grid-template-rows:64px 1fr; gap:10px;
    }
    header{
      display:flex; align-items:center; gap:10px; padding:8px 12px;
      background:var(--panel); border-bottom:1px solid var(--border);
      position:sticky; top:0; z-index:10;
    }
    header h1{ font-size:16px; font-weight:600; color:var(--titleBlue); margin:0; }
    main{ display:grid; grid-template-columns:360px 1fr; gap:10px; padding:0 10px 10px; }
    .left{
      background:var(--panel); border:1px solid var(--border); border-radius:12px; overflow:hidden;
      display:flex; flex-direction:column; min-height:0;
    }
    .left h2{ margin:0; padding:12px; font-size:14px; border-bottom:1px solid var(--border); color:var(--muted) }
    .paras{ overflow:auto; padding:8px; display:flex; flex-direction:column; gap:8px; }
    .para{
      background:#111522; border:1px solid var(--border); border-radius:10px; padding:10px;
      display:grid; grid-template-columns:1fr auto; gap:8px; align-items:start;
    }
    .para .ref{ color:#b9c2d0; font-weight:600; margin-bottom:6px }
    .para .text{ color:#dfe6f3; font-size:14px; line-height:1.5; }
    .para .actions{ display:flex; gap:6px }
    .btn{
      background:#1d2333; border:1px solid var(--border); color:var(--text);
      padding:6px 10px; border-radius:8px; cursor:pointer; font-size:12px;
    }
    .btn:hover{ border-color:#3a4258 }
    .btn.primary{ background:#19314f; border-color:#2a4f81; color:#cfe6ff }
    .btn.danger{ background:#3a1820; border-color:#6b1c2b; color:#ffc7cf }

    /* Popup Editor (window-like) */
    dialog#editor{ width:min(1100px, 92vw); max-height:90vh; padding:0; border:none; border-radius:14px; overflow:hidden; }
    .ed-wrap{ display:grid; grid-template-rows:56px 1fr 52px; height:90vh; background:var(--panel); color:var(--text); }
    .ed-head{
      display:flex; align-items:center; gap:8px; padding:8px 10px; border-bottom:1px solid var(--border);
      position:sticky; top:0; background:var(--panel); z-index:5;
    }
    .ed-title{
      display:flex; flex-direction:column; gap:4px; min-width:220px;
    }
    .ed-title small{ color:var(--muted); font-size:11px; }
    .ed-title input{
      width:240px; /* ì œëª©ë€ ë„ˆë¹„ë¥¼ ì¤„ì„ */
      background:#101522; color:var(--text); border:1px solid var(--border);
      border-radius:8px; padding:6px 8px; font-size:14px; text-align:left; /* ì™¼ìª½ ì •ë ¬ */
    }
    .ed-toolbar{ display:flex; flex-wrap:wrap; gap:6px; margin-left:auto }
    .tbtn{ border:1px solid var(--border); background:#0f1420; color:var(--text); padding:6px 9px; border-radius:8px; font-size:12px; cursor:pointer }
    .tbtn[data-active="1"]{ outline:2px solid var(--accent) }

    .ed-body{ overflow:auto; padding:12px; background:#0e111a }
    .paper{ background:var(--paper); color:var(--ink); border-radius:12px; padding:18px 18px 60px; min-height:760px; max-width:860px; margin:0 auto; }
    .paper:focus{ outline:2px solid var(--accent) }
    .paper h2{ margin:12px 0 6px 0 }
    .paper .verse{ font-style:italic; background:#fffbe6; padding:2px 4px; border-radius:6px }
    .paper .mark{ background:#ffeaa7 }

    .ed-foot{
      border-top:1px solid var(--border); display:flex; align-items:center; gap:8px; padding:6px 10px;
      position:sticky; bottom:0; background:var(--panel); z-index:5;
    }
    .stats{ color:var(--muted); font-size:12px; margin-right:auto }

    .ed-foot .btn{ padding:8px 12px }

    /* Print (A4) */
    @media print{
      body{ background:white }
      dialog#editor { width:auto; height:auto; }
      .ed-wrap{ display:block }
      .ed-head, .ed-foot{ display:none }
      .paper{ box-shadow:none; border:none; max-width:none; width:210mm; min-height:297mm; padding:20mm }
    }
  </style>
</head>
<body>
  <header>
    <h1>Webâ€‘Bibleâ€‘Paragraph 3.1 Â· Sermon Editor</h1>
    <span style="color:var(--muted); font-size:12px">ìƒ˜í”Œ ë°ì´í„° Â· ì¢Œì¸¡ ë‹¨ë½ì—ì„œ <b>ì„¤êµ</b>ë¥¼ ëˆŒëŸ¬ í¸ì§‘</span>
  </header>

  <main>
    <section class="left">
      <h2>ì„±ê²½ ë‹¨ë½</h2>
      <div class="paras" id="paraList"></div>
    </section>

    <section class="right" style="display:flex; align-items:center; justify-content:center; color:var(--muted)">
      <div>
        <div style="font-size:20px; color:#cfe1ff; text-align:center; margin-bottom:8px">Sermon Editor 3.1</div>
        <div style="text-align:center">ì¢Œì¸¡ì—ì„œ ë‹¨ë½ì„ ì„ íƒí•˜ì—¬ ì„¤êµ í¸ì§‘ì„ ì‹œì‘í•˜ì„¸ìš”.</div>
      </div>
    </section>
  </main>

  <!-- Editor Dialog -->
  <dialog id="editor">
    <div class="ed-wrap">
      <div class="ed-head">
        <div class="ed-title">
          <small id="autoSaveBadge">ìë™ì €ì¥ë¨</small>
          <input id="titleInput" placeholder="ì„¤êµ ì œëª©" />
        </div>
        <div class="ed-toolbar" id="toolbar">
          <button class="tbtn" data-cmd="undo" title="ë˜ëŒë¦¬ê¸° (Ctrl+Z)">â†¶</button>
          <button class="tbtn" data-cmd="redo" title="ë‹¤ì‹œí•˜ê¸° (Ctrl+Y)">â†·</button>
          <button class="tbtn" data-cmd="bold" title="êµµê²Œ (Ctrl+B)"><b>B</b></button>
          <button class="tbtn" data-cmd="italic" title="ê¸°ìš¸ì„ (Ctrl+I)"><i>I</i></button>
          <button class="tbtn" data-cmd="underline" title="ë°‘ì¤„ (Ctrl+U)"><u>U</u></button>
          <button class="tbtn" data-cmd="strikeThrough" title="ì·¨ì†Œì„ "><s>S</s></button>
          <button class="tbtn" data-cmd="formatBlock" data-value="H2" title="ì†Œì œëª©">H2</button>
          <button class="tbtn" data-cmd="insertUnorderedList" title="ë¶ˆë¦¿ ëª©ë¡">â€¢ List</button>
          <button class="tbtn" data-cmd="insertOrderedList" title="ë²ˆí˜¸ ëª©ë¡">1. List</button>
          <button class="tbtn" id="quoteBtn" title="ì¸ìš©">â€œ â€</button>
          <button class="tbtn" id="codeBtn" title="ì¸ë¼ì¸ ì½”ë“œ">{ }</button>
          <button class="tbtn" id="markBtn" title="í•˜ì´ë¼ì´íŠ¸">âœº</button>
          <button class="tbtn" id="linkBtn" title="ë§í¬">ğŸ”—</button>
          <button class="tbtn" id="clearBtn" title="ì„œì‹ ì´ˆê¸°í™”">CLR</button>
          <button class="tbtn" id="findBtn" title="ì°¾ê¸°/ë°”ê¾¸ê¸°">F/R</button>
        </div>
      </div>

      <div class="ed-body">
        <div class="paper" id="paper" contenteditable="true" spellcheck="false"></div>
      </div>

      <div class="ed-foot">
        <div class="stats" id="stats">0ì Â· 0ë‹¨ë½</div>
        <button class="btn" id="exportBtn">ë‚´ë³´ë‚´ê¸° (.sermon.json)</button>
        <label class="btn" for="importFile">ê°€ì ¸ì˜¤ê¸°<input id="importFile" type="file" accept="application/json" style="display:none"/></label>
        <button class="btn" id="printBtn">ì¸ì‡„(A4)</button>
        <button class="btn danger" id="closeBtn">ë‹«ê¸°(Esc)</button>
      </div>
    </div>
  </dialog>

  <script>
    // -----------------------------
    // ìƒ˜í”Œ ë°ì´í„° (ì±…/ì¥/ë‹¨ë½)
    // -----------------------------
    const BIBLE = {
      book: 'ì—­ëŒ€í•˜', chap: 32,
      paras: [
        { id:'2Chr-32-1', ref:'ì—­ëŒ€í•˜ 32:1-8', text:'ì´ ì¼ í›„ì— ì•—ìˆ˜ë¥´ ì™• ì‚°í—¤ë¦½ì´ ì™€ì„œ ìœ ë‹¤ì— ë“¤ì–´ì™€ ëª¨ë“  ê²¬ê³ í•œ ì„±ì„ ëŒ€ì¹˜í•˜ê³  ì ë ¹í•˜ë ¤ í•˜ë‹ˆë¼â€¦' },
        { id:'2Chr-32-9', ref:'ì—­ëŒ€í•˜ 32:9-15', text:'ê·¸ ë•Œì— ì•—ìˆ˜ë¥´ ì™• ì‚°í—¤ë¦½ì´ ê·¸ì˜ ì‹ ë³µë“¤ì„ ì˜ˆë£¨ì‚´ë ˜ìœ¼ë¡œ ë³´ë‚´ì–´ íˆìŠ¤ê¸°ì•¼ì™€ ìœ ë‹¤ ëª¨ë“  ì‚¬ëŒì„ ì¹˜ìš•ë˜ê²Œ í•˜ë©°â€¦' },
        { id:'2Chr-32-20', ref:'ì—­ëŒ€í•˜ 32:20-23', text:'ì´ì‚¬ì•¼ ì„ ì§€ìì™€ íˆìŠ¤ê¸°ì•¼ ì™•ì´ í•˜ëŠ˜ì„ í–¥í•˜ì—¬ ë¶€ë¥´ì§–ì–´ ê¸°ë„í•˜ì˜€ë”ë‹ˆâ€¦' },
      ]
    }

    // -----------------------------
    // ë¡œì»¬ ì €ì¥ ìœ í‹¸
    // -----------------------------
    function LS_KEY(pid){ return `WBP-3.1:sermon:${pid}` }
    function loadSermon(pid){
      try{ const raw = localStorage.getItem(LS_KEY(pid)); return raw ? JSON.parse(raw) : null }catch(e){ return null }
    }
    function saveSermon(pid, data){ localStorage.setItem(LS_KEY(pid), JSON.stringify(data)) }

    // -----------------------------
    // UI: ì¢Œì¸¡ ë‹¨ë½ ëª©ë¡
    // -----------------------------
    const paraList = document.getElementById('paraList');
    BIBLE.paras.forEach(p => {
      const $ = document.createElement('div'); $.className='para'; $.dataset.pid=p.id;
      $.innerHTML = `
        <div>
          <div class="ref">${p.ref}</div>
          <div class="text">${p.text}</div>
        </div>
        <div class="actions">
          <button class="btn primary" data-action="edit">ì„¤êµ</button>
          <button class="btn" data-action="preview">ë¯¸ë¦¬ë³´ê¸°</button>
          <button class="btn" data-action="clear">ì´ˆê¸°í™”</button>
        </div>`;
      paraList.appendChild($);
    });

    paraList.addEventListener('click', (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const host = e.target.closest('.para'); const pid = host.dataset.pid;
      if(btn.dataset.action==='edit') openSermonEditor(pid);
      if(btn.dataset.action==='preview') previewSermon(pid);
      if(btn.dataset.action==='clear') { if(confirm('ì´ ë‹¨ë½ ì„¤êµë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?')) { localStorage.removeItem(LS_KEY(pid)); alert('ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.'); } }
    });

    function previewSermon(pid){
      const s = loadSermon(pid);
      alert(s ? `ì œëª©: ${s.title || ''}\n\n${s.html.replace(/<[^>]+>/g,'\n').slice(0,400)}...` : 'ì €ì¥ëœ ì„¤êµê°€ ì—†ìŠµë‹ˆë‹¤.');
    }

    // -----------------------------
    // Editor ìƒíƒœ
    // -----------------------------
    let CURRENT_PID = null;
    const editor = document.getElementById('editor');
    const titleInput = document.getElementById('titleInput');
    const paper = document.getElementById('paper');
    const autoBadge = document.getElementById('autoSaveBadge');
    const stats = document.getElementById('stats');

    function openSermonEditor(pid){
      CURRENT_PID = pid;
      const stored = loadSermon(pid);
      titleInput.value = stored?.title || '';
      paper.innerHTML = stored?.html || defaultTemplateFor(pid);
      touchSaved();
      updateStats();
      if(!editor.open) editor.showModal();
      paper.focus();
    }

    function defaultTemplateFor(pid){
      const ref = BIBLE.paras.find(p=>p.id===pid)?.ref || '';
      return `
        <h2>${ref} â€“ ì„¤êµ ë…¸íŠ¸</h2>
        <p class="verse">ë³¸ë¬¸ ì¸ìš©ì„ ë¶™ì—¬ë„£ê³ , ìë™ìœ¼ë¡œ <span class="mark">í•˜ì´ë¼ì´íŠ¸</span>ë‚˜ <em>ê¸°ìš¸ì„</em> í‘œì‹œë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ìš”.</p>
        <p>â‘  ì„œë¡  â€” ë³¸ë¬¸ ë§¥ë½ê³¼ ë¬¸ì œ ì œê¸°</p>
        <p>â‘¡ ë³¸ë¡  â€” ì£¼ì œ 1</p>
        <p>â‘¢ ë³¸ë¡  â€” ì£¼ì œ 2</p>
        <p>â‘£ ê²°ë¡  â€” ì ìš©ê³¼ ê²°ë‹¨</p>
      `;
    }

    // -----------------------------
    // Toolbar ë™ì‘ (document.execCommand ê¸°ë°˜ ê°„ë‹¨ êµ¬í˜„)
    // -----------------------------
    const toolbar = document.getElementById('toolbar');
    toolbar.addEventListener('click', (e)=>{
      const b = e.target.closest('.tbtn'); if(!b) return;
      const cmd = b.dataset.cmd; const val = b.dataset.value || null;
      paper.focus();
      if(cmd){ document.execCommand(cmd, false, val); syncActiveStates(); scheduleSave(); updateStats(); return }
    });

    // ì¶”ê°€ ë²„íŠ¼: ì¸ìš©/ì½”ë“œ/ë§ˆí¬/ë§í¬/í´ë¦¬ì–´/ì°¾ê¸°ë°”ê¾¸ê¸°
    document.getElementById('quoteBtn').onclick = ()=>{ surroundSelection('<blockquote>','</blockquote>') }
    document.getElementById('codeBtn').onclick  = ()=>{ surroundSelection('<code>','</code>') }
    document.getElementById('markBtn').onclick  = ()=>{ surroundSelection('<span class="mark">','</span>') }
    document.getElementById('linkBtn').onclick  = ()=>{
      const url = prompt('ë§í¬ URLì„ ì…ë ¥í•˜ì„¸ìš”:'); if(!url) return;
      document.execCommand('createLink', false, url); scheduleSave();
    }
    document.getElementById('clearBtn').onclick = ()=>{
      const n = getSelectionHtml();
      if(!n) return; const tmp = n.replace(/<[^>]+>/g,'');
      replaceSelectionWithHtml(tmp); scheduleSave(); updateStats();
    }
    document.getElementById('findBtn').onclick = ()=>{ openFindReplace() }

    function surroundSelection(before, after){
      const html = getSelectionHtml(); if(!html) return;
      replaceSelectionWithHtml(before + html + after); scheduleSave(); updateStats();
    }

    function getSelectionHtml(){
      const sel = window.getSelection(); if(!sel || sel.rangeCount===0) return '';
      const range = sel.getRangeAt(0);
      const frag = range.cloneContents(); const div = document.createElement('div');
      div.appendChild(frag); return div.innerHTML;
    }
    function replaceSelectionWithHtml(html){
      document.execCommand('insertHTML', false, html);
    }

    function syncActiveStates(){
      // ê°„ë‹¨í•œ active UI (ì„ íƒì )
    }

    // -----------------------------
    // ì €ì¥ (ë””ë°”ìš´ìŠ¤)
    // -----------------------------
    let saveTimer = null;
    function scheduleSave(){
      markDirty();
      clearTimeout(saveTimer);
      saveTimer = setTimeout(doSave, 500);
    }
    function doSave(){
      if(!CURRENT_PID) return;
      const data = { title: titleInput.value.trim(), html: paper.innerHTML, ts: Date.now() };
      saveSermon(CURRENT_PID, data);
      touchSaved();
    }
    function markDirty(){ autoBadge.textContent = 'ì €ì¥ ì¤‘â€¦'; autoBadge.style.color = '#ffd38b' }
    function touchSaved(){ autoBadge.textContent = 'ìë™ì €ì¥ë¨'; autoBadge.style.color = 'var(--muted)' }

    titleInput.addEventListener('input', scheduleSave);
    paper.addEventListener('input', ()=>{ scheduleSave(); updateStats(); });

    // -----------------------------
    // í†µê³„
    // -----------------------------
    function updateStats(){
      const text = paper.innerText || '';
      const chars = text.replace(/\s/g,'').length;
      const paras = (paper.querySelectorAll('p, h1, h2, h3, blockquote, li').length) || 0;
      stats.textContent = `${chars}ì Â· ${paras}ë‹¨ë½`;
    }

    // -----------------------------
    // ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸°/ì¸ì‡„/ë‹«ê¸°
    // -----------------------------
    document.getElementById('exportBtn').onclick = ()=>{
      if(!CURRENT_PID) return;
      const payload = { pid: CURRENT_PID, title: titleInput.value.trim(), html: paper.innerHTML };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type:'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=`${CURRENT_PID}.sermon.json`; a.click();
      URL.revokeObjectURL(url);
    }
    document.getElementById('importFile').onchange = (e)=>{
      const f = e.target.files?.[0]; if(!f) return; const r = new FileReader();
      r.onload = ()=>{ try{ const j = JSON.parse(r.result);
          if(j && j.pid && j.html!==undefined){ CURRENT_PID = j.pid; titleInput.value = j.title||''; paper.innerHTML=j.html; doSave(); updateStats(); }
        }catch(err){ alert('JSON íŒŒì‹± ì˜¤ë¥˜'); } };
      r.readAsText(f);
    }
    document.getElementById('printBtn').onclick = ()=>{ window.print() }
    document.getElementById('closeBtn').onclick = ()=>{ editor.close() }

    editor.addEventListener('close', ()=>{ CURRENT_PID=null })
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && editor.open) editor.close() })

    // -----------------------------
    // ê°„ë‹¨í•œ ì°¾ê¸°/ë°”ê¾¸ê¸°
    // -----------------------------
    function openFindReplace(){
      const kw = prompt('ì°¾ì„ ë‹¨ì–´?'); if(!kw) return;
      const repl = prompt('ë°”ê¿€ ë‚´ìš©(ì·¨ì†Œ ì‹œ ì°¾ê¸°ë§Œ)');
      if(repl===null){
        // ì°¾ê¸°: ì²« ë§¤ì¹˜ë¡œ ìŠ¤í¬ë¡¤
        const rx = new RegExp(kw.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'i');
        const walker = document.createTreeWalker(paper, NodeFilter.SHOW_TEXT);
        let node; while(node=walker.nextNode()){ if(rx.test(node.nodeValue)){
          const range = document.createRange();
          const idx = node.nodeValue.toLowerCase().indexOf(kw.toLowerCase());
          range.setStart(node, Math.max(0, idx)); range.setEnd(node, Math.max(0, idx+kw.length));
          const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(range);
          paper.focus(); paper.scrollIntoView({behavior:'smooth', block:'center'}); break;
        }}
      }else{
        paper.innerHTML = paper.innerHTML.replaceAll(kw, repl); scheduleSave(); updateStats();
      }
    }

    // -----------------------------
    // ë‹¨ë½ ë”ë¸”í´ë¦­ìœ¼ë¡œ ë°”ë¡œ í¸ì§‘
    // -----------------------------
    paraList.addEventListener('dblclick', (e)=>{
      const host = e.target.closest('.para'); if(host) openSermonEditor(host.dataset.pid)
    });
  </script>
</body>
</html>
