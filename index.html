<!DOCTYPE html>
<html lang="ko" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sermon-Editor-1.0</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#161922; --panel-2:#141824; --text:#e6e8ef; --muted:#9aa0ab;
      --accent:#6ea8fe; --border:#252a36; --danger:#ff6b6b; --ok:#4dd4ac; --warn:#ffd166;
      --verse-bg: rgba(110,168,254,.12); --mark-bg: rgba(255,230,0,.22);
      --verse-color:#ff5e5b; /* ë°ì€ ì£¼í™ìƒ‰ */
    }
    [data-theme="light"]{
      --bg:#f7f8fb; --panel:#ffffff; --panel-2:#f0f3f9; --text:#0f1220; --muted:#6b7280;
      --accent:#3b82f6; --border:#e5e7eb; --danger:#ef4444; --ok:#10b981; --warn:#eab308;
      --verse-bg: rgba(59,130,246,.12); --mark-bg: rgba(250,204,21,.25);
      --verse-color:#ff5e5b; /* ë¼ì´íŠ¸ í…Œë§ˆì—ì„œë„ ë™ì¼ ì£¼í™ìƒ‰ */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;
      display:grid; grid-template-rows:56px auto 40px; gap:10px;
    }
    header{
      display:flex; align-items:center; gap:8px; padding:8px 10px;
      background:var(--panel); border-bottom:1px solid var(--border);
      position:sticky; top:0; z-index:20;
    }
    .brand{font-weight:700; letter-spacing:.2px}
    .sep{flex:1}
    .btn{appearance:none; border:1px solid var(--border); background:var(--panel-2); color:var(--text);
      padding:6px 10px; border-radius:10px; cursor:pointer; font-size:14px}
    .btn:hover{outline:1px solid var(--accent)}
    .btn.ghost{background:transparent}
    .btn.ok{border-color:transparent; background:var(--ok); color:#08261d}
    .btn.danger{border-color:var(--danger); color:var(--danger); background:transparent}

    main{display:grid; grid-template-columns:320px 1fr; gap:10px; padding:0 10px}
    aside{
      background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:10px;
      display:flex; flex-direction:column; gap:10px; min-height:calc(100vh - 56px - 40px - 20px);
      position:sticky; top:66px; height:fit-content;
    }
    .card{background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:12px}

    .field{display:flex; flex-direction:column; gap:6px}
    .field label{font-size:12px; color:var(--muted)}
    .input, select{
      width:100%; padding:8px 10px; border-radius:12px; border:1px solid var(--border);
      background:var(--panel-2); color:var(--text); font-size:15px
    }

    .editor-wrap{display:flex; flex-direction:column; gap:10px}
    #title{font-size:24px; font-weight:700; padding:8px 12px}
    #content{
      min-height:60vh; padding:16px; border:1px solid var(--border); border-radius:16px;
      background:var(--panel); line-height:1.7; font-size:18px;
    }
    #content:focus{outline:2px solid var(--accent)}

    /* Notion ìŠ¤íƒ€ì¼ í…ìŠ¤íŠ¸ ìš”ì†Œ */
    #content h1{font-size:1.8em; margin:.8em 0 .4em}
    #content h2{font-size:1.5em; margin:.8em 0 .4em}
    #content h3{font-size:1.25em; margin:.8em 0 .4em}
    #content blockquote{border-left:4px solid var(--accent); margin:8px 0; padding:6px 10px; background:var(--panel-2)}
    #content ul{padding-left:1.2em}
    #content .toggle{border:1px dashed var(--border); border-radius:10px; padding:10px; margin:8px 0}
    #content .toggle > summary{cursor:pointer; list-style:none; font-weight:600}
    #content .toggle > summary::marker{display:none}
    #content .toggle[open]{background:var(--panel-2)}

    /* í•˜ì´ë¼ì´íŠ¸ ê·œì¹™ */
    #content .verse{
      font-style:italic;
      color:var(--verse-color);
      background:transparent; /* ê¸°ì¡´ íŒŒë€ ë°°ê²½ ì œê±° */
    }
    #content .verse-ref{
      color:var(--verse-color);
      font-style:normal;
      opacity:.95;
      margin-left:.35em;
      white-space:nowrap;
    }
    /* ì„±êµ¬ ë¸”ë¡ ê°„ ì—¬ë°± */
    .verse-block{ margin:.6em 0; }

    /* ì„±êµ¬ í•œ ì¤„ì”© ì¶œë ¥ì‹œ ì ˆí–‰ ìŠ¤íƒ€ì¼ */
    .verse-line{ margin:.2em 0; }

    #content .mark{background:var(--mark-bg); padding:0 .15em; border-radius:.25em}

    /* í˜ì´ì§€ ë‚˜ëˆ” */
    .page-break{border:0; border-top:2px dashed var(--border); margin:20px 0;}
    @media print{
      header, aside, footer{display:none !important}
      main{grid-template-columns:1fr}
      #content{background:#fff; color:#000; border:0}
      .page-break{page-break-before:always; border:0; height:0}
      body{background:#fff}
    }

    /* ì €ì¥ ëª©ë¡ */
    .list{display:flex; flex-direction:column; gap:6px; max-height:40vh; overflow:auto}
    .list-item{display:flex; gap:6px; align-items:center; justify-content:space-between; border:1px solid var(--border); border-radius:10px; padding:8px 10px}
    .row{display:flex; gap:6px; align-items:center}
    .sub{font-size:12px; color:var(--muted)}

    /* íˆ´íŒ/ë„ì›€ë§ */
    .hint{font-size:12px; color:var(--muted)}

    footer{display:flex; align-items:center; gap:10px; padding:6px 10px; border-top:1px solid var(--border); background:var(--panel)}
    #status{font-size:12px; color:var(--muted)}

    .badge{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:var(--panel-2); font-size:12px}
    .kbd{font-family:ui-monospace, Menlo, Consolas, monospace; padding:.1em .4em; border:1px solid var(--border); border-radius:6px}

    /* í˜„ì¬ ë¬¸ì¥ í•˜ì´ë¼ì´íŠ¸ */
    #content .sent{
      transition: background-color .15s ease, box-shadow .15s ease;
      border-radius:.25em;
    }
    #content .sent.current{
      background: rgba(255, 224, 102, .35); /* ëˆˆì— ì˜ ë„ëŠ” ë…¸ë€ í•˜ì´ë¼ì´íŠ¸ */
      box-shadow: 0 0 0 2px rgba(255, 224, 102, .55) inset;
    }
    /* ë‚­ë… + ASR ë™ì‹œ ì‚¬ìš© ì‹œë„ ë” ì§„í•˜ê²Œ */
    .asr-on #content .sent.current{
      background: rgba(255, 224, 102, .45);
      box-shadow: 0 0 0 2px rgba(255, 224, 102, .7) inset;
    }


    /* ì„¤êµì¶”ì (ìŒì„±) ìƒíƒœ/ì§„í–‰ë¥  */
    .asr-on .badge, .asr-on #asrState{ color:#0a513a }
    .asr-on #content .sent.current{ background:rgba(77,212,172,.28) }
    .asr-part{ background:linear-gradient(90deg, rgba(77,212,172,.28) var(--asrPct,0%), transparent 0%) }
    .asr-error{ outline:1px dashed var(--danger) }

    /* í”Œë¡œíŒ… íˆ´ë°” */
    .floatbar{position:absolute; z-index:50; display:flex; gap:6px; align-items:center; padding:6px; background:var(--panel); border:1px solid var(--border); border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.35)}
    .floatbar [class^="btn"], .floatbar .input, .floatbar select{font-size:13px}
    .floatbar[hidden]{display:none}
  </style>
</head>
<body>
  <header>
    <div class="brand">ğŸ“ Sermon-Editor-1.0</div>
    <span class="sep"></span>
    <button class="btn" id="openVerseDlg">ì„±êµ¬ì‚½ì…</button>
    <button class="btn" id="theme">ë¼ì´íŠ¸/ë‹¤í¬</button>
    <button class="btn" id="print">ì¸ì‡„ / PDF</button>
  </header>

  <main>
    <aside>
      <div class="card field">
        <label>ì„¤êµ ëª©ë¡ ê´€ë¦¬</label>
        <div class="row" style="gap:8px">
          <input id="saveName" class="input" placeholder="ì €ì¥ ì´ë¦„ (ì˜ˆ: 2025-11-02 ì£¼ì¼)" />
          <button class="btn ok" id="save">ì €ì¥</button>
        </div>
        <div class="list" id="savedList"></div>
      </div>

      <div class="card field">
        <label>í•œë¬¸ì¥ì”© ë‚­ë… Â· ì„¤êµ ì¶”ì </label>
        <div class="row" style="gap:6px; flex-wrap:wrap">
          <button class="btn" id="ttsToggle">â–¶ï¸ ë‚­ë…</button>
        </div>
        <div class="row" style="gap:8px; align-items:center">
          <label class="sub">ìŒì„±</label>
          <select id="voiceSel" class="input"></select>
        </div>
        <div class="row" style="gap:8px; align-items:center">
          <label class="sub">ì†ë„</label>
          <input type="range" id="rate" min="0.6" max="1.6" step="0.05" value="1"/>
          <span id="rateVal" class="sub">1.00Ã—</span>
        </div>
        <div class="row" style="gap:6px; flex-wrap:wrap; align-items:center">
          <button class="btn" id="micToggle">ğŸ™ ì„¤êµì¶”ì  ì‹œì‘</button>
          <span id="asrState" class="sub">ë§ˆì´í¬ êº¼ì§</span>
        </div>
        <div class="hint">ë³¸ë¬¸ì˜ ë¬¸ì¥ì„ ìë™ìœ¼ë¡œ ë¶„ë¦¬í•´ í˜„ì¬ ë¬¸ì¥ì„ <span class="badge">ë…¹ìƒ‰ í•˜ì´ë¼ì´íŠ¸</span>ë¡œ í‘œì‹œí•˜ê³  ìë™ ìŠ¤í¬ë¡¤í•©ë‹ˆë‹¤. ë¬¸ì¥ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ ë¬¸ì¥ë¶€í„° ì½ìŠµë‹ˆë‹¤.</div>
      </div>

      <div class="card field">
        <label>ì„±ê²½ ë°ì´í„° (bible.json)</label>
        <div class="row" style="gap:8px; align-items:center">
          <div id="bibleStatus" class="sub">ë¯¸ë¡œë”©</div>
          <span class="sep"></span>
          <input type="file" id="bibleFile" accept="application/json" style="display:none" />
          <button class="btn" id="bibleLoadBtn">ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>
        <div class="hint">í”„ë¡œì íŠ¸ í´ë”ì— <span class="kbd">bible.json</span>ì´ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤. ì—†ìœ¼ë©´ <b>ë¶ˆëŸ¬ì˜¤ê¸°</b>ë¡œ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.</div>
      </div>

      <div class="card hint">
        âŒ˜/Ctrl+S ìˆ˜ë™ì €ì¥ Â· Ctrl+B/I/U ì„œì‹ Â· Ctrl+K ë§í¬
      </div>
    </aside>

    <section class="editor-wrap">
      <input id="title" class="input" placeholder="ì„¤êµ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" />
      <div id="content" contenteditable="true" spellcheck="false">
        <h2>ìƒ˜í”Œ</h2>
        <p class="verse">â€œí•˜ë‚˜ë‹˜ì€ ì˜ì´ì‹œë‹ˆ ì˜ˆë°°í•˜ëŠ” ìê°€ ì˜ê³¼ ì§„ë¦¬ë¡œ ì˜ˆë°°í• ì§€ë‹ˆë¼.â€ (ìš” 4:24)</p>
        <p>ì„¤êµ ë³¸ë¬¸ê³¼ ì ìš©, ê²°ë‹¨ì„ ì‘ì„±í•˜ì„¸ìš”. <span class="mark">í•µì‹¬ ë¬¸ì¥ì€ í˜•ê´‘í‘œì‹œ</span>ë¡œ ê°•ì¡°í•˜ì„¸ìš”.</p>
        <details class="toggle"><summary>ì˜ˆí™”</summary><p>ì´ê³³ì„ ì—´ê³  ë‹«ìœ¼ë©° ì˜ˆí™”ë¥¼ ì •ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p></details>
        <hr class="page-break" />
        <h3>ê²°ë‹¨</h3>
        <ul>
          <li>í•œ ì£¼ê°„ ì‹¤ì²œ 1</li>
          <li>í•œ ì£¼ê°„ ì‹¤ì²œ 2</li>
        </ul>
      </div>
    </section>
  </main>

  <footer>
    <div id="status">ìë™ì €ì¥ ëŒ€ê¸° ì¤‘â€¦</div>
    <span class="sep"></span>
    <div class="badge">ì €ì¥ì†Œ: localStorage</div>
  </footer>

  <!-- í”Œë¡œíŒ… í¸ì§‘ íˆ´ë°” -->
  <div id="floatbar" class="floatbar" hidden>
    <select id="fBlockType" title="ì „í™˜ (ë¸”ë¡ ìœ í˜•)">
      <option value="p">í…ìŠ¤íŠ¸</option>
      <option value="h1">ì œëª©1</option>
      <option value="h2">ì œëª©2</option>
      <option value="h3">ì œëª©3</option>
      <option value="ul">ê¸€ë¨¸ë¦¬ ê¸°í˜¸ ëª©ë¡</option>
      <option value="toggle">í† ê¸€ëª©ë¡</option>
      <option value="page">í˜ì´ì§€ ë‚˜ëˆ”</option>
    </select>
    <button class="btn" id="fBold" title="êµµê²Œ (Ctrl+B)"><b>B</b></button>
    <button class="btn" id="fItalic" title="ê¸°ìš¸ì„ (Ctrl+I)"><i>I</i></button>
    <button class="btn" id="fUnderline" title="ë°‘ì¤„ (Ctrl+U)"><u>U</u></button>
    <input type="color" id="fColor" title="ê¸€ììƒ‰" />
    <button class="btn" id="fQuote" title="ì¸ìš©ë¬¸">â</button>
    <button class="btn" id="fMarkBtn" title="ì„ íƒì˜ì—­ ê°•ì¡°(.mark)">í˜•ê´‘</button>
    <button class="btn" id="fVerseBtn" title="ì„ íƒì˜ì—­ ì„±ê²½(.verse)">êµ¬ì ˆ</button>
    <select id="fFontFamily" title="ê¸€ê¼´">
      <option value="">ê¸€ê¼´</option>
      <option>system-ui</option>
      <option>Noto Serif KR</option>
      <option>Nanum Myeongjo</option>
      <option>Arial</option>
      <option>Times New Roman</option>
    </select>
    <select id="fFontSize" title="ê¸€ì í¬ê¸°">
      <option value="">í¬ê¸°</option>
      <option value="14">14</option>
      <option value="16">16</option>
      <option value="18" selected>18</option>
      <option value="20">20</option>
      <option value="22">22</option>
      <option value="24">24</option>
    </select>
    <button class="btn" id="fLinkBtn" title="ë§í¬">ğŸ”—</button>
    <button class="btn" id="fVerseInsertBtn" title="ì„±ê²½ êµ¬ì ˆ ì‚½ì…">âœš</button>
  </div>

  <!-- ë³¸ë¬¸ ë¶™ì—¬ë„£ê¸° ë‹¤ì´ì–¼ë¡œê·¸ -->
  <dialog id="passageDlg">
    <form method="dialog" class="card" style="min-width:min(720px, 90vw)">
      <h3 style="margin:0 0 8px">ë³¸ë¬¸ ì‚½ì…</h3>
      <div class="field">
        <label>í…ìŠ¤íŠ¸</label>
        <textarea id="passageText" class="input" rows="8" placeholder="ì—¬ê¸°ì— ë³¸ë¬¸ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”"></textarea>
      </div>
      <div class="row" style="justify-content:space-between; margin-top:8px">
        <div class="row" style="gap:8px">
          <label class="row sub" style="gap:6px"><input type="checkbox" id="asVerse" checked /> ì „ì²´ë¥¼ .verse ì²˜ë¦¬</label>
          <label class="row sub" style="gap:6px"><input type="checkbox" id="autoMark" /> ëŒ€ê´„í˜¸[ ] ì•ˆì€ .mark</label>
        </div>
        <div class="row" style="gap:6px">
          <button class="btn ghost" id="dlgCancel">ì·¨ì†Œ</button>
          <button class="btn ok" id="dlgInsert">ì‚½ì…</button>
        </div>
      </div>
    </form>
  </dialog>

  <!-- ì„±ê²½ êµ¬ì ˆ ì‚½ì…(ì°¸ì¡° ë¬¸ìì—´ ì…ë ¥) -->
  <dialog id="verseInsertDlg">
    <form method="dialog" class="card" style="min-width:min(520px, 90vw)">
      <h3 style="margin:0 0 8px">ì„±ê²½ êµ¬ì ˆ ì‚½ì…</h3>
      <div class="field">
        <label>êµ¬ì ˆ (ì˜ˆ: ì°½ì„¸ê¸° 1:1 ~ 2:3  ë˜ëŠ”  ìš” 4:24)</label>
        <input id="vref" class="input" placeholder="ì˜ˆ: ì°½ì„¸ê¸° 1:1~2:3 / ìš” 4:24" />
      </div>
      <div class="row" style="justify-content:flex-end; gap:6px; margin-top:10px">
        <button class="btn ghost" id="vCancel">ì·¨ì†Œ</button>
        <button class="btn ok" id="vInsert">ì‚½ì…</button>
      </div>
      <div class="hint">bible.jsonì€ ì‹œì‘ ì‹œ ìë™ ë¡œë“œë©ë‹ˆë‹¤. (í˜„ì¬ í´ë”)</div>
    </form>
  </dialog>

  <script>
    // ====== ìœ í‹¸ ======
    const $ = (sel,root=document)=>root.querySelector(sel);
    const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));
    const w = window, d = document;
    const content = $('#content');
    const titleEl = $('#title');
    const statusEl = $('#status');
    const STORAGE_KEY = 'sermon_editor_doc';
    const SAVED_KEY = 'sermon_editor_items';

    // ====== í…Œë§ˆ ì „í™˜ ======
    const themeBtn = $('#theme');
    const savedTheme = localStorage.getItem('sermon_theme');
    if(savedTheme) document.documentElement.setAttribute('data-theme', savedTheme);
    themeBtn.addEventListener('click', ()=>{
      const cur = document.documentElement.getAttribute('data-theme')==='light'?'dark':'light';
      document.documentElement.setAttribute('data-theme', cur);
      localStorage.setItem('sermon_theme', cur);
    });

    // ====== ì¸ì‡„ ======
    $('#print').addEventListener('click', ()=>window.print());

    // ====== execCommand ë³´ì¡° / ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ ======
    function cmd(name, value=null){ document.execCommand(name,false,value); saveSoon(); }
    function wrapSelection(tag, className){
      const sel = window.getSelection();
      if(!sel.rangeCount) return;
      const r = sel.getRangeAt(0);
      const el = document.createElement(tag);
      if(className) el.className = className;
      r.surroundContents(el);
      sel.removeAllRanges(); sel.addRange(r);
      saveSoon();
    }
    function applyInlineStyle(styleProp, value){
      const sel = window.getSelection();
      if(!sel.rangeCount) return;
      const r = sel.getRangeAt(0);
      const span = document.createElement('span');
      span.style[styleProp] = value;
      try{ r.surroundContents(span); }
      catch{
        span.appendChild(r.extractContents());
        r.insertNode(span);
      }
      saveSoon();
    }

    // ====== í”Œë¡œíŒ… íˆ´ë°” ======
    const floatbar = $('#floatbar');
    function selInContent(){
      const sel=window.getSelection();
      if(!sel || !sel.rangeCount) return false;
      const node = sel.anchorNode;
      return node && content.contains(node);
    }
    function placeFloatbar(){
      const sel = window.getSelection();
      if(!sel || !sel.rangeCount){ floatbar.hidden=true; return; }
      const r = sel.getRangeAt(0);
      if(r.collapsed || !selInContent()){ floatbar.hidden=true; return; }
      const rect = r.getBoundingClientRect();
      const fb = floatbar; fb.hidden=false;
      const top = (rect.top + window.scrollY) - fb.offsetHeight - 8;
      const left = (rect.left + rect.width/2 + window.scrollX) - fb.offsetWidth/2;
      fb.style.top = Math.max(8, top) + 'px';
      fb.style.left = Math.max(8, left) + 'px';
    }
    ['mouseup','keyup'].forEach(ev=> content.addEventListener(ev, placeFloatbar));
    document.addEventListener('scroll', ()=>{ if(!floatbar.hidden) placeFloatbar(); }, {passive:true});
    document.addEventListener('mousedown', (e)=>{ if(!floatbar.contains(e.target) && !content.contains(e.target)) floatbar.hidden=true; });

    // í”Œë¡œíŒ… íˆ´ë°” ì´ë²¤íŠ¸
    $('#fBold').onclick = ()=>cmd('bold');
    $('#fItalic').onclick = ()=>cmd('italic');
    $('#fUnderline').onclick = ()=>cmd('underline');
    $('#fQuote').onclick = ()=>cmd('formatBlock','blockquote');
    $('#fColor').addEventListener('input', e=>cmd('foreColor', e.target.value));
    $('#fMarkBtn').onclick = ()=>wrapSelection('span','mark');
    $('#fVerseBtn').onclick = ()=>wrapSelection('span','verse');
    $('#fLinkBtn').onclick = ()=>{
      const url = prompt('ë§í¬ URL ì…ë ¥', 'https://');
      if(url) cmd('createLink', url);
    }
    $('#fFontFamily').onchange = e=>{ if(e.target.value) applyInlineStyle('fontFamily', e.target.value); };
    $('#fFontSize').onchange = e=>{ if(e.target.value) applyInlineStyle('fontSize', e.target.value+'px'); };

    $('#fBlockType').onchange = (e)=>{
      const v = e.target.value;
      if(v==='p') cmd('formatBlock','p');
      else if(v==='h1') cmd('formatBlock','h1');
      else if(v==='h2') cmd('formatBlock','h2');
      else if(v==='h3') cmd('formatBlock','h3');
      else if(v==='ul') cmd('insertUnorderedList');
      else if(v==='page') insertPageBreak();
      else if(v==='toggle') insertToggleFromSelection();
      e.target.value='p';
      placeFloatbar();
    };

    // í”Œë¡œíŒ… [âœš]ë„ í”„ë¡¬í”„íŠ¸ ì‚¬ìš©
    document.getElementById('fVerseInsertBtn')?.addEventListener('click', () => { saveCaret(); insertBiblePrompt(); });

    // ====== ë¸”ë¡ ì‚½ì… ìœ í‹¸ ======
    function insertPageBreak(){
      const hr = document.createElement('hr'); hr.className='page-break';
      insertNodeAtCaret(hr);
      saveSoon();
    }
    function insertToggleFromSelection(){
      const sel = window.getSelection();
      const details = document.createElement('details');
      details.className = 'toggle';
      const sum = document.createElement('summary'); sum.textContent = 'ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”';
      const p = document.createElement('p'); p.textContent = 'ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”';
      details.append(sum, p);
      if(sel && sel.rangeCount && !sel.isCollapsed){
        const r = sel.getRangeAt(0);
        const text = r.toString();
        sum.textContent = text.split('\n')[0] || 'í† ê¸€';
        try{ r.deleteContents(); }catch{}
      }
      insertNodeAtCaret(details);
      saveSoon();
    }

    // === caret save/restore ===
    let _savedRange = null;
    function saveCaret(){
      const sel = window.getSelection();
      if(sel && sel.rangeCount && content.contains(sel.anchorNode)){
        _savedRange = sel.getRangeAt(0).cloneRange();
      }else{
        _savedRange = null;
      }
    }
    function restoreCaret(){
      const sel = window.getSelection();
      if(_savedRange){
        sel.removeAllRanges();
        sel.addRange(_savedRange);
      }else{
        const r = document.createRange();
        r.selectNodeContents(content);
        r.collapse(false);
        sel.removeAllRanges();
        sel.addRange(r);
      }
    }
    function insertNodeAtCaret(node){
      const sel = window.getSelection();
      if(sel && sel.rangeCount && content.contains(sel.anchorNode)){
        const r = sel.getRangeAt(0);
        r.collapse(true);
        r.insertNode(node);
        r.setStartAfter(node);
        r.setEndAfter(node);
        sel.removeAllRanges();
        sel.addRange(r);
      }else{
        content.appendChild(node);
        const r = document.createRange();
        r.setStartAfter(node);
        r.setEndAfter(node);
        sel.removeAllRanges();
        sel.addRange(r);
      }
      saveSoon();
    }

    // ====== ì„±ê²½ êµ¬ì ˆ ì‚½ì…(í”„ë¡¬í”„íŠ¸) ======
    const verseDlg = $('#verseInsertDlg'); // ë³´ì¡°ìš©
    document.getElementById('openVerseDlg').onclick = () => { saveCaret(); insertBiblePrompt(); };
    $('#vCancel').addEventListener('click', (e)=>{ e.preventDefault(); verseDlg.close(); });

    // ë³´ì¡° ë‹¤ì´ì–¼ë¡œê·¸ ê²½ë¡œë„ ìœ ì§€
    $('#vInsert').addEventListener('click', (e)=>{
      e.preventDefault();
      const refStr = ($('#vref').value||'').trim();
      if(!refStr){ alert('êµ¬ì ˆì„ ì…ë ¥í•˜ì„¸ìš”. ì˜ˆ: ì°½ì„¸ê¸° 1:1~2:3 / ìš” 4:24'); return; }
      if(!window.BIBLE){ alert('bible.jsonì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'); return; }
      const parsed = parseRefLine(refStr);
      if(!parsed){ alert('êµ¬ì ˆ í˜•ì‹ì„ í™•ì¸í•˜ì„¸ìš”. ì˜ˆ: ì°½ì„¸ê¸° 1:1~2:3 / ìš” 4:24'); return; }
      const verses = getVersesRangeFromBible(parsed);
      if(!verses.length){ alert('í•´ë‹¹ ë²”ìœ„ì—ì„œ ë³¸ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }

      const p = buildVerseParagraph(parsed, verses);
      restoreCaret();
      insertNodeAtCaret(p);

      verseDlg.close();
      $('#vref').value='';
      saveSoon();
    });

    // ====== ìë™ì €ì¥ & ìƒíƒœ ======
    let saveTimer=null; let lastSavedAt=null; let dirty=false;
    function saveSoon(){ dirty=true; status('ì‘ì„± ì¤‘â€¦'); clearTimeout(saveTimer); saveTimer=setTimeout(saveNow, 600); }
    function status(msg){ statusEl.textContent = msg; }
    function saveNow(){
      const data = {title:titleEl.value, html:content.innerHTML, t:Date.now()};
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      dirty=false; lastSavedAt=new Date();
      status(`ìë™ì €ì¥ë¨ Â· ${lastSavedAt.toLocaleTimeString()}`);
      refreshSavedListMetaHighlight();
    }
    ['input','keyup','change'].forEach(ev=>{
      content.addEventListener(ev, saveSoon); titleEl.addEventListener(ev, saveSoon);
    });

    // ì´ˆê¸° ë¡œë“œ
    (function initLoad(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw){ try{ const d=JSON.parse(raw); titleEl.value=d.title||''; content.innerHTML=d.html||''; }catch{} }
      status('ìë™ì €ì¥ ëŒ€ê¸° ì¤‘â€¦');
    })();

    // ====== ì„¤êµ ëª©ë¡ ======
    const saveBtn=$('#save'); const saveNameEl=$('#saveName'); const listEl=$('#savedList');
    function savedMap(){ try{return JSON.parse(localStorage.getItem(SAVED_KEY)||'{}')}catch{return{}} }
    function setSavedMap(m){ localStorage.setItem(SAVED_KEY, JSON.stringify(m)); }

    saveBtn.onclick = ()=>{
      const name = (saveNameEl.value||titleEl.value||'ë¬´ì œ').trim(); if(!name){ alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }
      const id = Date.now().toString(36);
      const m = savedMap();
      m[id] = {id, name, title:titleEl.value, html:content.innerHTML, updated:new Date().toISOString()};
      setSavedMap(m); refreshSavedList();
      status('ëª©ë¡ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
    };

    function refreshSavedList(){
      listEl.innerHTML='';
      const m = savedMap();
      const arr = Object.values(m).sort((a,b)=>new Date(b.updated)-new Date(a.updated));
      if(arr.length===0){ listEl.innerHTML = '<div class="sub">ì €ì¥ëœ ì„¤êµê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
      arr.forEach(it=>{
        const div = document.createElement('div'); div.className='list-item';
        const left = document.createElement('div'); left.className='row';
        const name = document.createElement('div'); name.textContent = it.name; name.style.fontWeight='600';
        const sub = document.createElement('div'); sub.className='sub'; sub.textContent = new Date(it.updated).toLocaleString();
        left.append(name, sub);
        const right = document.createElement('div'); right.className='row';
        const loadB = btn('ë¶ˆëŸ¬ì˜¤ê¸°', ()=>{ titleEl.value = it.title||it.name; content.innerHTML = it.html||''; saveSoon(); });
        const renB = btn('ì´ë¦„', ()=>{
          const nv = prompt('ìƒˆ ì´ë¦„', it.name); if(!nv) return; const m=savedMap(); m[it.id].name = nv; m[it.id].updated=new Date().toISOString(); setSavedMap(m); refreshSavedList();
        });
        const delB = btn('ì‚­ì œ', ()=>{
          if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){ const m=savedMap(); delete m[it.id]; setSavedMap(m); refreshSavedList(); }
        });
        delB.classList.add('danger');
        right.append(loadB, renB, delB);
        div.append(left, right);
        listEl.append(div);
      });
    }
    function btn(txt, fn){ const b=document.createElement('button'); b.className='btn'; b.textContent=txt; b.onclick=fn; return b; }
    function refreshSavedListMetaHighlight(){ /* reserve for future */ }
    refreshSavedList();

    // ====== ë‹¨ì¶•í‚¤ ======
    document.addEventListener('keydown', (e)=>{
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); saveNow(); }
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); $('#fLinkBtn').click(); }
    });

    // ====== í•œë¬¸ì¥ì”© ë‚­ë… + ì„¤êµ ì¶”ì  (TTS) ======
    let SENT_WRAPPED=false; let curIdx=0; let sentences=[]; let autoplay=false;
    const synth = window.speechSynthesis;
    const voiceSel = $('#voiceSel');
    const rate = $('#rate'); const rateVal = $('#rateVal');

    function awaitVoices(timeout=1500){
      return new Promise(resolve=>{
        const vs = synth.getVoices();
        if (vs && vs.length) return resolve(vs);
        const t = setTimeout(()=> resolve(synth.getVoices()), timeout);
        if (typeof speechSynthesis !== 'undefined'){
          speechSynthesis.onvoiceschanged = ()=>{
            clearTimeout(t);
            resolve(synth.getVoices());
          };
        }
      });
    }
    async function populateVoices(){
      const vs = await awaitVoices();
      voiceSel.innerHTML='';
      if (!vs || !vs.length){
        const opt = document.createElement('option');
        opt.value = ''; opt.textContent = 'ìŒì„±ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ';
        voiceSel.append(opt);
        return;
      }
      vs.forEach((v)=>{
        const opt = document.createElement('option');
        opt.value = v.name; opt.textContent = `${v.name} (${v.lang})`;
        voiceSel.append(opt);
      });
      const prefer = vs.find(v=>/^ko/i.test(v.lang)) || vs.find(v=>/^en/i.test(v.lang)) || vs[0];
      if (prefer) voiceSel.value = prefer.name;
    }
    populateVoices();
    voiceSel.addEventListener('change', ()=>{
      if (!sentences.length) return;
      if (autoplay) speakCurrent();
    });

    rate.addEventListener('input', ()=>{ rateVal.textContent = Number(rate.value).toFixed(2)+'Ã—'; });

    // ì‚¬ìš©ì ì œìŠ¤ì²˜ì—ì„œ ì˜¤ë””ì˜¤ ì ê¸ˆ í•´ì œ
    let audioUnlocked = false;
    function unlockAudio(){
      if (audioUnlocked) return;
      try { speechSynthesis.resume(); } catch {}
      audioUnlocked = true;
    }
    ['click','keydown','touchstart'].forEach(ev=>{
      window.addEventListener(ev, unlockAudio, { once:true, passive:true });
    });

    function wrapSentences(){
      if(SENT_WRAPPED){ sentences = $$('#content .sent'); return; }
      const walker = document.createTreeWalker(content, NodeFilter.SHOW_TEXT, {
        acceptNode(node){
          if(!node.nodeValue.trim()) return NodeFilter.FILTER_REJECT;
          if(node.parentElement && (node.parentElement.closest('script,style,details summary'))) return NodeFilter.FILTER_REJECT;
          return NodeFilter.FILTER_ACCEPT;
        }
      });
      const REG=/([^.!?\n\r\t\u3002\uFF01\uFF1F]+[.!?\u3002\uFF01\uFF1F]\s*)/g;
      const toWrap=[];
      while(walker.nextNode()){
        const n = walker.currentNode;
        const txt = n.nodeValue;
        if(REG.test(txt)){
          REG.lastIndex=0; let idx=0; let m; const parts=[];
          while((m=REG.exec(txt))!==null){
            const s=m[0];
            parts.push(s);
            idx += s.length;
          }
          const rest = txt.slice(idx);
          if(rest.trim()) parts.push(rest);
          if(parts.length>0){ toWrap.push([n, parts]); }
        }
      }
      toWrap.forEach(([node, parts])=>{
        const frag=document.createDocumentFragment();
        parts.forEach(p=>{
          const span=document.createElement('span'); span.className='sent'; span.textContent=p; frag.appendChild(span);
        });
        node.replaceWith(frag);
      });
      SENT_WRAPPED=true; sentences = $$('#content .sent');
      sentences.forEach((s,idx)=> s.addEventListener('click', ()=>{startAt(idx);}));
    }

    function speakCurrent(){
      if(!sentences.length) return;
      curIdx = Math.max(0, Math.min(curIdx, sentences.length - 1)); // ì¸ë±ìŠ¤ ë³´ì •
      const s = sentences[curIdx];
      sentences.forEach(x=>x.classList.remove('current'));
      s.classList.add('current'); s.scrollIntoView({behavior:'smooth', block:'center'});
      const u = new SpeechSynthesisUtterance(s.textContent.trim());

      const voices = synth.getVoices();
      let vv = voices.find(v=>v.name===voiceSel.value);
      if (!vv) vv = voices.find(v=>/^ko/i.test(v.lang)) || voices[0];
      if (vv) u.voice = vv;
      u.lang = (vv && vv.lang) ? vv.lang : 'ko-KR';

      u.rate = Number(rate.value)||1;
      u.onend = ()=>{
        sentences.forEach(x=>x.classList.remove('current'));
        if(autoplay && curIdx < sentences.length - 1){
          curIdx++;
          speakCurrent();   // ë‹¤ìŒ ë¬¸ì¥ ìë™ ì¬ìƒ
        } else {
          autoplay = false;
          updateTtsBtn();  // ë²„íŠ¼ì„ â€˜â–¶ï¸ ë‚­ë…â€™ìœ¼ë¡œ ë³µê·€
        }
      };

      u.onerror = (e)=>{ autoplay=false; console.warn('TTS error', e); };

      try { synth.cancel(); } catch {}
      try { synth.speak(u); } catch (e) {
        console.warn('speak failed, retrying once', e);
        setTimeout(()=> { try { synth.speak(u); } catch{} }, 120);
      }
    }

    function startAt(i=0){ wrapSentences(); curIdx = Math.max(0, Math.min(i, sentences.length-1)); autoplay=true; speakCurrent(); updateTtsBtn(); }
    function stopAll(){ autoplay=false; synth.cancel(); updateTtsBtn(); sentences.forEach(x=>x.classList.remove('current')); }
    function next(){ if(curIdx < sentences.length-1){ curIdx++; speakCurrent(); } else { stopAll(); } }
    function prev(){ if(curIdx>0){ curIdx--; speakCurrent(); } }

    $('#ttsToggle').onclick = ()=>{
      wrapSentences();
      if (!sentences.length){ alert('ë‚­ë…í•  ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤. ë³¸ë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
      if(autoplay){
        stopAll(); // ì •ì§€
      }else{
        startAt(curIdx||0); // ë‚­ë… ì‹œì‘
      }
    };

    function updateTtsBtn(){
      $('#ttsToggle').textContent = autoplay ? 'â–  ì •ì§€' : 'â–¶ï¸ ë‚­ë…';
    }

    content.addEventListener('click', (e)=>{
      const sent = e.target.closest('.sent');
      if(!sent) return;
      const idx = sentences.indexOf(sent);
      if(idx < 0) return;
      curIdx = idx;
      autoplay = true;
      speakCurrent();      // í´ë¦­í•œ ë¬¸ì¥ë¶€í„° ì¦‰ì‹œ ë‚­ë…
      updateTtsBtn();
    });

    content.addEventListener('input', ()=>{ SENT_WRAPPED=false; sentences=[]; floatbar.hidden=true; });

    // ====== ì„±ê²½ ë°ì´í„° ë¡œë”© (bible.json) ======
    const BIBLE_CACHE_KEY = 'sermon_editor_bible_json';
    const bibleStatus = $('#bibleStatus');
    const bibleLoadBtn = $('#bibleLoadBtn');
    const bibleFile = $('#bibleFile');

    function setBibleStatus(txt){ if(bibleStatus) bibleStatus.textContent = txt; }

    function loadBibleFromCache(){
      const raw = localStorage.getItem(BIBLE_CACHE_KEY);
      if(!raw) return false;
      try{ window.BIBLE = JSON.parse(raw); setBibleStatus('ë¡œì»¬ ìºì‹œ ì‚¬ìš©'); return true; }catch{ return false; }
    }
    async function fetchBibleDefault(){
      try{
        const resp = await fetch('bible.json', {cache:'reload'});
        if(!resp.ok) return false;
        const json = await resp.json();
        window.BIBLE = json; localStorage.setItem(BIBLE_CACHE_KEY, JSON.stringify(json));
        setBibleStatus('ìë™ ë¡œë“œ ì„±ê³µ');
        return true;
      }catch{ return false; }
    }
    function handleBibleFile(file){
      if(!file) return;
      const fr = new FileReader();
      fr.onload = ()=>{
        try{
          const json = JSON.parse(fr.result);
          window.BIBLE = json;
          localStorage.setItem(BIBLE_CACHE_KEY, fr.result);
          setBibleStatus('íŒŒì¼ ë¡œë“œ ì„±ê³µ');
        }catch{
          alert('JSON íŒŒì‹± ì‹¤íŒ¨: íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”');
        }
      };
      fr.readAsText(file,'utf-8');
    }
    if(bibleLoadBtn){ bibleLoadBtn.addEventListener('click', ()=> bibleFile.click()); }
    if(bibleFile){ bibleFile.addEventListener('change', (e)=> handleBibleFile(e.target.files[0])); }

    (async function initBible(){
      if(loadBibleFromCache()) return;
      if(await fetchBibleDefault()) return;
      setBibleStatus('ë¯¸ë¡œë”©');
    })();

    // êµ¬ì ˆ íŒŒì„œ & ì¡°íšŒê¸°
    function normalizeBook(name){
      if(!window.BIBLE) return null;
      const keys = Object.keys(window.BIBLE);
      if(keys.includes(name)) return name;
      const hit = keys.find(k=>k.startsWith(name)); // ì ‘ë‘ ì¼ì¹˜(ì°½ â†’ ì°½ì„¸ê¸°)
      return hit || null;
    }

    function parseRefLine(str){
      const s = String(str).replace(/\s+/g,' ').trim();
      const m = s.match(/^([^\d:]+)\s+(\d+):(\d+)\s*(?:[~\-]\s*(?:(\d+):)?(\d+))?\s*$/);
      if(!m) return null;

      const bookRaw = m[1].trim();     // ì‚¬ìš©ìê°€ ì…ë ¥í•œ í‘œê¸° ê·¸ëŒ€ë¡œ ë³´ì¡´ (ì˜ˆ: 'ìš”', 'ì°½ì„¸ê¸°')
      const ch1 = parseInt(m[2], 10);
      const vs1 = parseInt(m[3], 10);
      const ch2 = m[4] ? parseInt(m[4], 10) : null;
      const vs2 = m[5] ? parseInt(m[5], 10) : null;

      const book = normalizeBook(bookRaw); // ë‚´ë¶€ ì¡°íšŒìš© ì •ê·œí™” í‚¤
      if(!book) return null;

      const base = { book, bookLabel: bookRaw }; // bookLabelì„ ì¶”ê°€ë¡œ ë³´ì¡´

      if(!vs2 && !ch2){
        return { ...base, start:{ch:ch1, vs:vs1}, end:{ch:ch1, vs:vs1} };
      }
      if(!ch2 && vs2){
        return { ...base, start:{ch:ch1, vs:vs1}, end:{ch:ch1, vs:vs2} };
      }
      return { ...base, start:{ch:ch1, vs:vs1}, end:{ch:ch2||ch1, vs:vs2||vs1} };
    }

    // bible.jsonì—ì„œ ë²”ìœ„ ë³¸ë¬¸ ëª¨ìœ¼ê¸° (ì ˆ ë²ˆí˜¸ í¬í•¨)
    function getVersesRangeFromBible(ref){
      const out = [];
      const B = window.BIBLE;
      if(!B) return out;

      const {book, start, end} = ref;
      let ch = start.ch, vs = start.vs;

      function beforeOrEq(a){
        if(a.ch < end.ch) return true;
        if(a.ch === end.ch && a.vs <= end.vs) return true;
        return false;
      }

      while(beforeOrEq({ch,vs})){
        const chObj = B?.[book]?.[String(ch)];
        if(!chObj) break;

        const text = chObj[String(vs)];
        if(text) out.push(`${vs}. ${text}`);

        vs++;
        if(!chObj[String(vs)]){
          ch++; vs = 1;
          if(!B?.[book]?.[String(ch)]) break;
        }
      }
      return out;
    }

    function parseRef(str){
      if(!str) return null;
      const m = str.replace(/\s+/g,'').match(/^([^\d:]+)(\d+)(?::(\d+)(?:-(\d+))?)?$/);
      if(!m) return null;
      const bookRaw=m[1], chap=m[2], v1=m[3]||null, v2=m[4]||null;
      const book = normalizeBook(bookRaw);
      if(!book) return null;
      return {
        book,
        chap:String(parseInt(chap,10)),
        v1: v1? String(parseInt(v1,10)) : null,
        v2: v2? String(parseInt(v2,10)) : null
      };
    }
    function getVerseTextFromBible(refStr, opt={includeNum:true}){
      if(!window.BIBLE) return '';
      const p = parseRef(refStr);
      if(!p) return '';
      const {book, chap, v1, v2} = p;
      const ch = window.BIBLE[book] && window.BIBLE[book][chap];
      if(!ch) return '';
      const start = v1? parseInt(v1,10) : 1;
      const end   = v2? parseInt(v2,10) : (v1? start : start);
      const out=[];
      for(let i=start;i<=end;i++){
        const t = ch[String(i)];
        if(!t) continue;
        out.push(opt.includeNum? `${i}. ${t}` : t);
      }
      return out.join(' ');
    }

    // === ì„±êµ¬ì‚½ì…: í”„ë¡¬í”„íŠ¸ ì…ë ¥ â†’ ê¸°ìš¸ì„ + ì£¼í™ìƒ‰ + <ì„±ê²½ëª… ì¥:ì ˆ(~ì¥:ì ˆ)> í‘œì‹œ ===
    async function insertBiblePrompt(){
      const raw = w.prompt('ì‚½ì…í•  ì„±ê²½êµ¬ì ˆ (ì˜ˆ: ìš” 3:16, ì°½ì„¸ê¸° 1:1-3, ì‹œ 23:1~3)');
      if(!raw) return;
      if(!w.BIBLE){ alert('bible.jsonì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'); return; }

      const norm = String(raw)
        .replace(/\s+/g, ' ')
        .replace(/[â€“â€”ï¼]/g, '-')
        .replace(/[ï¼š]/g, ':')
        .trim();

      const parsed = parseRefLine(norm);
      if(!parsed){ alert('í˜•ì‹: ì„±ê²½ì´ë¦„ ì¥:ì ˆ ë˜ëŠ” ì¥:ì ˆ-ì ˆ (ì˜ˆ: ì°½ì„¸ê¸° 1:1-3 / ìš” 3:16 / ì‹œ 23:1~3)'); return; }

      const verses = getVersesRangeFromBible(parsed);
      if(!verses.length){ alert('í•´ë‹¹ ë²”ìœ„ì—ì„œ ë³¸ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }

      restoreCaret();
      const p = buildVerseParagraph(parsed, verses);
      insertNodeAtCaret(p);
      saveSoon();
    }
    function buildVerseParagraph(parsed, versesArr){
      const { bookLabel, start, end } = parsed;
      const sameChapter = (start.ch === end.ch);
      const rangeLabel = sameChapter
        ? (start.vs === end.vs ? `${start.ch}:${start.vs}` : `${start.ch}:${start.vs}-${end.vs}`)
        : `${start.ch}:${start.vs}~${end.ch}:${end.vs}`;

      const refHtml = `&lt;${escapeHtml(bookLabel)} ${rangeLabel}&gt;`;

      // ì»¨í…Œì´ë„ˆ(div) ìƒì„±: ì°¸ì¡° 1ì¤„ + ê° ì ˆì„ í•œ ì¤„ì”© <p>ë¡œ
      const box = document.createElement('div');
      box.className = 'verse-block';

      // 1) ì°¸ì¡° ì¤„
      const pRef = document.createElement('p');
      pRef.innerHTML = `<span class="verse-ref">${refHtml}</span>`;
      box.appendChild(pRef);

      // 2) ê° ì ˆì„ í•œ ì¤„ì”©
      versesArr.forEach(line => {
        const p = document.createElement('p');
        p.className = 'verse-line';
        p.innerHTML = `<span class="verse">${escapeHtml(line)}</span>`;
        box.appendChild(p);
      });

      return box; // insertNodeAtCaretì— ì»¨í…Œì´ë„ˆ ë‹¨ìœ„ë¡œ ì‚½ì…
    }



    // ====== ë“œë˜í”„íŠ¸ ìë™ì €ì¥ ë³´ì¡° ======
    window.addEventListener('beforeunload', (e)=>{ if(dirty){ saveNow(); } });

    // ====== ì„¤êµì¶”ì  (ASR) ======
    (function(){
      const asrSupported = ('webkitSpeechRecognition' in window) || ('SpeechRecognition' in window);
      let recognizer = null; let micOn = false; let partialText = '';

      function norm(s){
        return (s||'')
          .replace(/[.,!?;:"'()\[\]{}]/g,' ')
          .replace(/\s+/g,' ')
          .trim()
          .toLowerCase();
      }
      function coverage(spoken, target){
        const a = norm(spoken).split(' ').filter(Boolean);
        const b = norm(target).split(' ').filter(Boolean);
        if(!a.length || !b.length) return 0;
        let i=0, hit=0;
        for(const w of a){
          if(i<b.length && w===b[i]){ hit++; i++; }
          else{
            const pos = b.indexOf(w, i);
            if(pos>=0){ i = pos+1; hit++; }
          }
        }
        return hit / b.length;
      }
      function updatePartialFill(pct){
        const s = sentences && sentences[curIdx]; if(!s) return;
        s.style.setProperty('--asrPct', Math.max(0, Math.min(100, Math.round(pct*100))) + '%');
        s.classList.toggle('asr-part', pct>0);
      }
      function ensureRecognizer(){
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        const r = new SR();
        r.lang = 'ko-KR';
        r.interimResults = true;
        r.continuous = true;
        r.maxAlternatives = 1;

        r.onresult = (ev)=>{
          let interim = '', final='';
          for(let i=ev.resultIndex; i<ev.results.length; i++){
            const res = ev.results[i];
            if(res.isFinal) final += ' ' + res[0].transcript; else interim += ' ' + res[0].transcript;
          }
          if(final){ partialText += ' ' + final; }
          const spoken = (partialText + ' ' + interim).trim();
          const sEl = sentences && sentences[curIdx];
          if(!sEl) return;

          const cov = coverage(spoken, sEl.textContent);
          updatePartialFill(cov);
          if(cov >= 0.9){ partialText=''; next(); }
        };
        r.onerror = (e)=>{
          const st=$('#asrState'); if(st) st.textContent = 'ì˜¤ë¥˜: ' + (e.error||'unknown');
          document.body.classList.add('asr-error');
        };
        r.onend = ()=>{ if(micOn){ try{ r.start(); }catch{} } };
        return r;
      }
      function setAsrState(txt){ const st=$('#asrState'); if(st) st.textContent = txt; }
      function startMic(){
        if(!asrSupported){ alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (Chrome ê¶Œì¥)'); return; }
        wrapSentences(); if(!sentences || !sentences.length){ alert('ì½ì„ ë¬¸ì¥ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
        if(!recognizer) recognizer = ensureRecognizer();
        try{ recognizer.start(); }catch{}
        micOn = true; document.body.classList.add('asr-on');
        const btn=$('#micToggle'); if(btn) btn.textContent='ğŸ›‘ ì„¤êµì¶”ì  ì •ì§€'; setAsrState('ë“£ëŠ” ì¤‘â€¦');
        if(!sentences[curIdx]) curIdx = 0; speakCurrent();
      }
      function stopMic(){
        micOn = false; partialText='';
        document.body.classList.remove('asr-on');
        if(recognizer){ try{ recognizer.stop(); }catch{} }
        const btn=$('#micToggle'); if(btn) btn.textContent='ğŸ™ ì„¤êµì¶”ì  ì‹œì‘'; setAsrState('ë§ˆì´í¬ êº¼ì§');
        updatePartialFill(0);
      }
      const micBtn = $('#micToggle');
      if(micBtn){ micBtn.addEventListener('click', ()=>{ micOn ? stopMic() : startMic(); }); }

    const _origSpeak = speakCurrent;
    window.speakCurrent = function(){
      curIdx = Math.max(0, Math.min(curIdx, sentences.length - 1));
      updatePartialFill(0);
      partialText='';
      _origSpeak();
    };

    content.addEventListener('input', ()=>{ if(micOn){ partialText=''; updatePartialFill(0); } });
    })();

    // ====== ë³¸ë¬¸ ì‚½ì… ë‹¤ì´ì–¼ë¡œê·¸ ======
    const passageDlg = $('#passageDlg');
    $('#dlgCancel').onclick = (e)=>{ e.preventDefault(); passageDlg.close(); };
    $('#dlgInsert').onclick = (e)=>{
      e.preventDefault();
      const text = $('#passageText').value || '';
      const asVerse = $('#asVerse').checked;
      const autoMark = $('#autoMark').checked;
      if(!text.trim()) { passageDlg.close(); return; }
      const frag = document.createDocumentFragment();
      text.split(/\n+/).forEach(line=>{
        if(!line.trim()) return;
        const p = document.createElement('p');
        let html = escapeHtml(line);
        if(autoMark) html = html.replace(/\[(.+?)\]/g, '<span class="mark">$1</span>');
        p.innerHTML = asVerse ? `<span class="verse">${html}</span>` : html;
        frag.appendChild(p);
      });
      insertNodeAtCaret(frag);
      passageDlg.close();
      $('#passageText').value='';
      saveSoon();
    };

    function escapeHtml(s){return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')}
  </script>
</body>
</html>
